// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client" 
  output="generated" 
  previewFeatures=["fullTextSearchPostgres"]

} 


datasource db {
  provider = "postgresql" 
  url=env("DATABASE_URL")
} 



model ProspectiveRehabs {
id Int @id @default(autoincrement())
npi_number String @unique
organization_name String
address String?
city String?
state String?
postal_code String?
phone String?
taxonomy_code String?
taxonomy_desc String?
last_updated DateTime?
ingested Boolean @default(false)


@@index([npi_number])
@@map("prospective_rehabs") 

}


model InsuranceProvider {
id Int @id @default(autoincrement())
payer_code String @unique
payer_name String 
display_name String? 
type String?
eligibility String?


@@index([payer_code])
@@map("insurance_providers") 

}  


// ------------------------------------------------------
// Enums
// ------------------------------------------------------

enum InsuranceScope {
  ORG
  CAMPUS
  PROGRAM
} 

enum InsuranceEligibilityStatus {
  PENDING
  VERIFIED
  DENIED
  ERROR
  UNKNOWN
}

enum NetworkStatus {
  UNKNOWN
  IN_NETWORK
  OUT_OF_NETWORK
  CASE_BY_CASE
}

enum WaitlistCategory {
  NONE
  SHORT
  MEDIUM
  LONG
}

enum ReviewSource {
  INTERNAL
  GOOGLE
  HEALTHGRADES
  FACEBOOK
  OTHER
}

enum ReviewerType {
  PATIENT
  LOVED_ONE
  CLINICIAN
  OTHER
}

enum StoryType {
  PATIENT_STORY
  FAMILY_STORY
  PROGRAM_OVERVIEW
  ORIGIN_STORY
  OUTCOME_CASE
  OTHER
}

enum LevelOfCareType {
  DETOX
  RESIDENTIAL
  PHP
  IOP
  OUTPATIENT
  AFTERCARE
  TELEHEALTH
  SOBER_LIVING
  OTHER
}   


enum PreAssessmentQuestionInputType {
  SHORT_TEXT
  LONG_TEXT
  INTEGER
  DECIMAL
  BOOLEAN
  SINGLE_SELECT
  MULTI_SELECT
  DATE
  DATETIME
  SCALE_1_10
}

// ----------------- 
// Intake models 
// ---------------- 


model PreAssessmentForm {
  id          String   @id @default(cuid())
  slug        String   @unique          // "default-intake-v1"
  name        String                  // "Default Intake Form v1"
  description String?
  version     Int      @default(1)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   PreAssessmentFormQuestion[]
  submissions UserPreAssessmentSubmission[]
}

model PreAssessmentFormQuestion {
  id        String   @id @default(cuid())
  formId    String

  // Stable key for analytics / mapping even if label changes
  questionKey String   // e.g. "primary_substance", "days_sober_last_30"

  label       String   // Human-facing question text
  description String?  // Helper text under the label

  inputType   PreAssessmentQuestionInputType
  isRequired  Boolean  @default(false)
  sortOrder   Int      @default(0)

  // For select questions: options, value-label pairs, etc.
  // Example:
  // [
  //   { "value": "ALCOHOL", "label": "Alcohol" },
  //   { "value": "OPIOIDS", "label": "Opioids" }
  // ]
  options     Json?

  // You can stash conditional visibility logic here if you need it later
  visibilityLogic Json? // e.g. { "showIf": { "questionKey": "has_dual_diagnosis", "equals": true } }

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  form       PreAssessmentForm @relation(fields: [formId], references: [id])
  answers    UserPreAssessmentAnswer[]

  @@index([formId])
  @@unique([formId, questionKey])
}   

enum UserRole { 
  LOVED_ONE  
  USER 
  ADMIN 
  MASTER 
}
model AdminUser {  
  id String @id @default(cuid())   
  name String? 
  email String @unique 
  hashedPassword String  
  role UserRole    
  full_priveleges Boolean @default(false)

}

model UserPreAssessmentSubmission {
  id                  String   @id @default(cuid())
  userProfileId       String
  preAssessmentFormId String

  submittedAt         DateTime @default(now())
  status              String?  // "COMPLETED", "IN_PROGRESS", etc.

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // History relation (profile -> many submissions)
  userProfile UserProfile @relation("ProfilePreAssessmentSubmissions",fields: [userProfileId],references: [id])

  // Back-reference for the "latest" pointer
  // NOTE: no fields[]/references[] here because the FK
  // lives on UserProfile.latestPreAssessmentSubmissionId
  profileWhereLatest UserProfile? @relation("LatestPreAssessmentSubmission")

  form    PreAssessmentForm       @relation(fields: [preAssessmentFormId], references: [id])
  answers UserPreAssessmentAnswer[]

  @@index([userProfileId])
  @@index([preAssessmentFormId])
  // @@unique([userProfileId, preAssessmentFormId]) // optional constraint
}

model UserPreAssessmentAnswer {
  id           String   @id @default(cuid())
  submissionId String
  questionId   String

  // Store the raw answer as JSON so it can handle:
  // - text:       "Alcohol"
  // - number:     7
  // - boolean:    true
  // - single:     "INPATIENT"
  // - multi:      ["DEPRESSION", "ANXIETY"]
  value        Json

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submission   UserPreAssessmentSubmission @relation(fields: [submissionId], references: [id])
  question     PreAssessmentFormQuestion   @relation(fields: [questionId], references: [id])

  @@index([submissionId])
  @@index([questionId])
  @@unique([submissionId, questionId]) // one answer per question in that submission
}

// ------------------------------ 
// User Models 
// ---------------------------------------  

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  hashedPassword String 

  profileImageUrl String? 

  // auth / status flags
  emailVerifiedAt DateTime?
  isActive        Boolean  @default(true)    

  role UserRole @default(USER) 

  





  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastLoginAt    DateTime?

  profile        UserProfile?
  sessions       UserSession[]

  savedRehabOrgs     UserSavedRehabOrg[]
  savedRehabCampuses UserSavedRehabCampus[]
  savedRehabPrograms UserSavedRehabProgram[] 
 
 insuranceProfiles UserInsuranceProfile[] 

  
}  

model UserInsuranceProfile {
  id              String   @id @default(cuid())

  // ownership
  userId          String
  insurancePayerId String

  // optional: which rehab context this profile is associated with
  rehabOrgId      String?
  rehabCampusId   String?
  rehabProgramId  String?

  // core identity from the card
  memberId        String
  groupNumber     String?
  planName        String?

  // privacy-friendly fingerprint for dedupe
  cardHash        String?   // e.g. SHA-256 of normalized card image

  // eligibility / verification
  eligibilityStatus      InsuranceEligibilityStatus @default(PENDING)
  eligibilityCheckedAt   DateTime?
  eligibilityReferenceId String? // ID from clearinghouse / payer API
  eligibilityNotes       String?

  // optional: only if you choose to actually keep images
  frontImageKey    String? // e.g. "insurance-cards/{userId}/front-<uuid>.jpg"
  backImageKey     String?

  isPrimary        Boolean  @default(true)   // current ‚Äúmain‚Äù insurance for this user
  isActive         Boolean  @default(true)   // soft-delete / historical tracking

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt 

  pVerifyApprovalRun Json? // THe pverify run 

  // ‚îÄ‚îÄ‚îÄ Relations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  user           User           @relation(fields: [userId], references: [id])
  insurancePayer InsurancePayer @relation(fields: [insurancePayerId], references: [id])

  rehabOrg       RehabOrg?      @relation(fields: [rehabOrgId], references: [id])


  @@index([userId])
  @@index([insurancePayerId])
  @@index([rehabOrgId])
  @@index([userId, isActive, isPrimary])
}



model UserSession {
  id              String   @id @default(cuid())
  userId          String

  // Store hashed refresh tokens here, *not* raw tokens
  refreshTokenHash String

  userAgent       String?
  ipAddress       String?

  // Token lifecycle
  expiresAt       DateTime
  revokedAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([refreshTokenHash])
}

// ------------------------------------------------------
// User Profiles & Pre-Assessment
// ------------------------------------------------------

model UserProfile {
  id      String @id @default(cuid())
  userId  String @unique

  // --- existing profile fields (name, phone, location, etc.) ---
  firstName   String?
  lastName    String?
  phone       String?
  preferredContactMethod String?
  city        String?
  state       String?
  postalCode  String?
  country     String?
  dateOfBirth    DateTime?
  genderIdentity String?
  pronouns       String?

  // High-level clinical flags
  primaryConcern          String?
  hasCoOccurringDisorders Boolean?
  priorTreatmentHistory   String?

  // Link to "main" form & submission if you want quick access
  latestPreAssessmentSubmissionId String? @unique 


  // This is the "latest" pointer
  latestPreAssessmentSubmission UserPreAssessmentSubmission? @relation("LatestPreAssessmentSubmission",fields: [latestPreAssessmentSubmissionId],references: [id])

  // This is the full history list
  preAssessmentSubmissions UserPreAssessmentSubmission[] @relation("ProfilePreAssessmentSubmissions")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User   @relation(fields: [userId], references: [id])
}

// ------------------------------------------------------
// Saved rehabs (user favorites / shortlist)
// ------------------------------------------------------

model UserSavedRehabOrg {
  userId    String
  rehabOrgId String

  savedAt   DateTime @default(now())
  notes     String?

  user      User    @relation(fields: [userId], references: [id])
  rehabOrg  RehabOrg @relation(fields: [rehabOrgId], references: [id])

  @@id([userId, rehabOrgId])
  @@index([rehabOrgId])
}

model UserSavedRehabCampus {
  userId      String
  rehabCampusId String

  savedAt     DateTime @default(now())
  notes       String?

  user        User       @relation(fields: [userId], references: [id])
  rehabCampus RehabCampus @relation(fields: [rehabCampusId], references: [id])

  @@id([userId, rehabCampusId])
  @@index([rehabCampusId])
}

model UserSavedRehabProgram {
  userId      String
  rehabProgramId String

  savedAt     DateTime @default(now())
  notes       String?

  user        User        @relation(fields: [userId], references: [id])
  rehabProgram RehabProgram @relation(fields: [rehabProgramId], references: [id])

  @@id([userId, rehabProgramId])
  @@index([rehabProgramId])
}



// ------------------------------------------------------
// Top-level org hierarchy
// ------------------------------------------------------ 

model ParentCompany {
  id                  String   @id @default(cuid())
  name                String   @unique   

  slug                String   @unique
  websiteUrl          String?
  description         String?

  verifiedExists      Boolean  @default(false) 

  heroImageUrl      String?  
  galleryImageUrls   String[]

  headquartersStreet   String?
  headquartersCity     String?
  headquartersState    String?
  headquartersPostalCode String?
  headquartersCountry  String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  youtubeChannels     YoutubeChannel[]
  socialMediaProfiles SocialMediaProfile[]

  rehabOrgs           RehabOrg[] 

  @@index([name])
}

model YoutubeChannel {
  id              String   @id @default(cuid())
  url             String   @unique 
  parentCompanyId String?
  rehabOrgId      String? 

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  parentCompany   ParentCompany? @relation(fields: [parentCompanyId], references: [id])
  rehabOrg        RehabOrg?      @relation(fields: [rehabOrgId], references: [id])
  videos          YoutubeVideo[]

  @@index([parentCompanyId])
  @@index([rehabOrgId])
}

model YoutubeVideo {
  id        String   @id @default(cuid())
  channelId String?

  title     String?
  url       String @unique 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  channel   YoutubeChannel? @relation(fields: [channelId], references: [id])

  @@index([channelId])
}

model SocialMediaProfile {
  id            String   @id @default(cuid())
  platform      String
  url           String @unique 

  parentCompanyId String?
  rehabOrgId      String?
  rehabCampusId   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  parentCompany   ParentCompany? @relation(fields: [parentCompanyId], references: [id])
  rehabOrg        RehabOrg?      @relation(fields: [rehabOrgId], references: [id])
  rehabCampus     RehabCampus?   @relation(fields: [rehabCampusId], references: [id])
}

// ------------------------------------------------------
// RehabOrg (brand-level org)
// ------------------------------------------------------  






model RehabOrg {
  id              String   @id @default(cuid())
  parentCompanyId String?  

  state String?
  city String?
  zip String?
  country String?

  name            String @unique 
  slug            String   @unique
  legalName       String?
  npi_number       String?  // NPI-2 where available

  description     String?
  tagline         String? 
  heroImageUrl    String? 
  galleryImageUrls String[]

  websiteUrl      String?
  mainPhone       String?
  mainEmail       String?

  yearFounded     Int?
  isNonProfit     Boolean? @default(false)

  // Search / verification
  verifiedExists   Boolean  @default(false)
  primarySourceUrl String?
  otherSourceUrls  String[] // text[]
  baseCurrency     String?  // e.g. "USD"
  fullPrivatePrice Int?     // typical 30-day or similar

  defaultTimeZone  String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  parentCompany    ParentCompany? @relation(fields: [parentCompanyId], references: [id])

  // Hierarchy
  campuses         RehabCampus[]

  // Org-level flags / lookups (join tables)
  orgAccreditations    RehabAccreditation[]
  orgReviews           OrgReview[]
  orgTestimonials      OrgTestimonial[]
  orgStories           OrgStory[]

  insurancePayers      RehabInsurancePayer[]
  paymentOptions       RehabPaymentOption[]

  // üîπ Reverse relations for rehab-level join tables
  levelsOfCare         RehabLevelOfCare[]
  detoxServices        RehabDetoxService[]
  services             RehabService[]
  populations          RehabPopulation[]
  languages            RehabLanguage[]
  amenities            RehabAmenity[]
  environments         RehabEnvironment[]
  settingStyles        RehabSettingStyle[]
  luxuryTiers          RehabLuxuryTier[]
  programFeaturesGlobal RehabProgramFeatureGlobal[]

  // Media
  youtubeChannels      YoutubeChannel[]
  socialMediaProfiles  SocialMediaProfile[] 

  savedByUsers UserSavedRehabOrg[] 

  userInsuranceProfile UserInsuranceProfile[]
}

// ------------------------------------------------------
// Campus (physical locations)
// ------------------------------------------------------

model RehabCampus {
  id                     String @id @default(cuid())
  rehabOrgId             String

  name                   String
  slug                   String   @unique
  displayName            String?
  description            String? 

  heroImageUrl    String? 
  galleryImageUrls String[]

  street                 String
  city                   String
  state                  String
  postalCode             String
  country                String

  latitude               Float?
  longitude              Float?

  phone                  String?
  email                  String?
  timeZone               String?

  visitingHours          String?
  directionsSummary      String?

  // Operational capacity
  bedsTotal              Int?
  bedsDetox              Int?
  bedsResidential        Int?
  bedsOutpatientCapacity Int?

  acceptsWalkIns           Boolean? @default(false)
  hasOnsiteMD              Boolean? @default(false)
  hasTwentyFourHourNursing Boolean? @default(false)

  // Primary aesthetic descriptors (can be overridden by program level)
  primaryEnvironmentId  String?
  primarySettingStyleId String?
  primaryLuxuryTierId   String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  rehabOrg              RehabOrg      @relation(fields: [rehabOrgId], references: [id])
  primaryEnvironment    Environment?  @relation("CampusPrimaryEnvironment", fields: [primaryEnvironmentId], references: [id])
  primarySettingStyle   SettingStyle? @relation("CampusPrimarySettingStyle", fields: [primarySettingStyleId], references: [id])
  primaryLuxuryTier     LuxuryTier?   @relation("CampusPrimaryLuxuryTier", fields: [primaryLuxuryTierId], references: [id])

  programs              RehabProgram[]

  campusAmenities       RehabCampusAmenity[]
  campusLanguages       RehabCampusLanguage[]
  campusPopulations     RehabCampusPopulation[]
  campusEnvironments    RehabCampusEnvironment[]
  campusSettingStyles   RehabCampusSettingStyle[]
  campusLuxuryTiers     RehabCampusLuxuryTier[]

  campusReviews         CampusReview[]
  campusTestimonials    CampusTestimonial[]
  campusStories         CampusStory[]


  socialMediaProfiles   SocialMediaProfile[] 

  savedByUsers          UserSavedRehabCampus[]

  @@index([rehabOrgId])
}

// ------------------------------------------------------
// Program (actual care tracks)
// ------------------------------------------------------

model RehabProgram {
  id                    String @id @default(cuid())
  campusId              String
  levelOfCareId         String

  name                  String   @unique 
  slug                  String   @unique
  shortName             String?
  description           String? 

    heroImageUrl    String? 
  galleryImageUrls String[]

  targetPopulationSummary String?
  clinicalFocusSummary    String?

  // Program structure
  minLengthOfStayDays     Int?
  maxLengthOfStayDays     Int?
  typicalLengthOfStayDays Int?

  sessionScheduleSummary  String?  // e.g. "Mon‚ÄìFri evenings", "Daily full-time"
  checkInDays             String[] // e.g. ["MONDAY","WEDNESDAY"]

  intakePhone             String?
  intakeEmail             String?

  // Clinical characteristics
  isDetoxPrimary          Boolean? @default(false)
  isMATProgram            Boolean? @default(false)
  hasOnsiteMD             Boolean? @default(false)
  hasTwentyFourHourNursing Boolean? @default(false)
  staffToPatientRatio     Float?

  acceptsSelfReferral     Boolean? @default(true)
  acceptsCourtOrdered     Boolean? @default(false)
  acceptsMedicallyComplex Boolean? @default(false)

  waitlistCategory        WaitlistCategory @default(NONE)
  waitlistDescription     String?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  campus                  RehabCampus  @relation(fields: [campusId], references: [id])
  levelOfCare             LevelOfCare @relation(fields: [levelOfCareId], references: [id])

  programDetoxServices    RehabProgramDetoxService[]
  programServices         RehabProgramService[]
  programPopulations      RehabProgramPopulation[]
  programLanguages        RehabProgramLanguage[]
  programAmenities        RehabProgramAmenity[]
  programFeatures         RehabProgramFeature[]
  programMATTypes         RehabProgramMATType[]
  programSubstances       RehabProgramSubstance[]

  programReviews          ProgramReview[]
  programTestimonials     ProgramTestimonial[]
  programStories          ProgramStory[]



  savedByUsers             UserSavedRehabProgram[]

  @@index([campusId])
  @@index([levelOfCareId])
}

// ------------------------------------------------------
// Lookups: levels-of-care, services, detox, MAT, etc.
// ------------------------------------------------------

model LevelOfCare {
  id          String          @id @default(cuid())
  type        LevelOfCareType @default(OTHER)
  slug        String          @unique  // "detox", "residential", "php", "iop", "outpatient", "aftercare"
  displayName String
  description String?

  programs    RehabProgram[]
  rehabs      RehabLevelOfCare[]
}

model DetoxService {
  id          String @id @default(cuid())
  slug        String @unique  // "alcohol_detox", "opioid_detox", ...
  displayName String @unique 
  description String?

  programLinks RehabProgramDetoxService[]
  rehabLinks   RehabDetoxService[]
}

model MATType {
  id              String @id @default(cuid())
  slug            String @unique // "methadone", "buprenorphine", "naltrexone", etc.
  displayName     String @unique 
  medicationClass String? // "opioid_agonist", "partial_agonist", "antagonist"
  description     String?

  programLinks    RehabProgramMATType[]
}

model Service {
  id          String @id @default(cuid()) 
  slug        String @unique  // "individual_counseling", "group_counseling", "cbt", "emdr"
  displayName String @unique 
  description String?

  programLinks RehabProgramService[]
  rehabLinks   RehabService[]
}

model Population {
  id          String @id @default(cuid())
  slug        String @unique  // "adults", "teens", "veterans", "lgbtq", etc.
  displayName String @unique 
  description String?

  programLinks RehabProgramPopulation[]
  campusLinks  RehabCampusPopulation[]
  rehabLinks   RehabPopulation[]
}

model Accreditation {
  id          String @id @default(cuid())
  slug        String @unique  // "carf", "joint_commission", etc.
  displayName String @unique 
  description String?

  orgLinks    RehabAccreditation[]
}

model Language {
  id          String @id @default(cuid())
  code        String @unique // "en", "es", ...
  displayName String @unique 
  description String?

  programLinks RehabProgramLanguage[]
  campusLinks  RehabCampusLanguage[]
  rehabLinks   RehabLanguage[]
}

model Amenity {
  id          String @id @default(cuid())
  slug        String @unique  // "private_rooms", "gourmet_meals", ...
  displayName String @unique 
  description String?

  programLinks RehabProgramAmenity[]
  campusLinks  RehabCampusAmenity[]
  rehabLinks   RehabAmenity[]
}

model Environment {
  id          String @id @default(cuid())
  slug        String @unique  // "beach", "mountains", "desert", "city"
  displayName String @unique 
  description String?

  // üîπ campuses that use this as their primary environment
  primaryCampuses RehabCampus[] @relation("CampusPrimaryEnvironment")

  campusLinks     RehabCampusEnvironment[]
  rehabLinks      RehabEnvironment[]
}

model SettingStyle {
  id          String @id @default(cuid())
  slug        String @unique  // "hospital", "residential_neighborhood", "resort", ...
  displayName String @unique 
  description String?

  // üîπ campuses that use this as their primary style
  primaryCampuses RehabCampus[] @relation("CampusPrimarySettingStyle")

  campusLinks     RehabCampusSettingStyle[]
  rehabLinks      RehabSettingStyle[]
}

model LuxuryTier {
  id          String @id @default(cuid())
  slug        String @unique  // "average", "executive", "luxury", "ultra_luxury"
  displayName String @unique 
  rank        Int?
  description String?

  // üîπ campuses that use this as their primary tier
  primaryCampuses RehabCampus[] @relation("CampusPrimaryLuxuryTier")

  campusLinks     RehabCampusLuxuryTier[]
  rehabLinks      RehabLuxuryTier[]
}

model ProgramFeature {
  id          String @id @default(cuid())
  slug        String @unique  // "same_day_admission", "twenty_four_hour_assistance", ...
  displayName String @unique 
  description String?

  programLinks RehabProgramFeature[]
  rehabLinks   RehabProgramFeatureGlobal[]
}

model PaymentOption {
  id                 String @id @default(cuid())
  slug               String @unique  // "cash_self_pay", "sliding_scale", etc.
  displayName        String @unique 
  description        String?

  rehabPaymentOptions RehabPaymentOption[]
}

model InsurancePayer {
  id          String @id @default(cuid())   
  companyName String @unique 
  slug        String @unique       // "aetna", "bcbs", ...
  displayName String @unique  
  logoImageUrl String?
  description String?

  payerType   String?       
           // "commercial", "medicare", "medicaid", etc.


  rehabs      RehabInsurancePayer[] 
  users UserInsuranceProfile[]
}

model Substance {
  id          String @id @default(cuid())
  slug        String @unique  // "alcohol", "opioids", "benzodiazepines", "stimulants"
  displayName String @unique 
  category    String?         // "depressant", "stimulant", etc.
  description String?

  programLinks RehabProgramSubstance[]
}

// ------------------------------------------------------
// Rehab-level join tables (high-level flags)
// ------------------------------------------------------

model RehabLevelOfCare {
  rehabId       String
  levelOfCareId String

  rehab       RehabOrg    @relation(fields: [rehabId], references: [id])
  levelOfCare LevelOfCare @relation(fields: [levelOfCareId], references: [id])

  @@id([rehabId, levelOfCareId])
}

model RehabDetoxService {
  rehabId        String
  detoxServiceId String

  rehab        RehabOrg     @relation(fields: [rehabId], references: [id])
  detoxService DetoxService @relation(fields: [detoxServiceId], references: [id])

  @@id([rehabId, detoxServiceId])
}

model RehabService {
  rehabId   String
  serviceId String

  rehab   RehabOrg @relation(fields: [rehabId], references: [id])
  service Service  @relation(fields: [serviceId], references: [id])

  @@id([rehabId, serviceId])
}

model RehabPopulation {
  rehabId      String
  populationId String

  rehab      RehabOrg   @relation(fields: [rehabId], references: [id])
  population Population @relation(fields: [populationId], references: [id])

  @@id([rehabId, populationId])
}

model RehabAccreditation {
  rehabId         String
  accreditationId String

  rehab         RehabOrg      @relation(fields: [rehabId], references: [id])
  accreditation Accreditation @relation(fields: [accreditationId], references: [id])

  @@id([rehabId, accreditationId])
}

model RehabLanguage {
  rehabId    String
  languageId String

  rehab    RehabOrg @relation(fields: [rehabId], references: [id])
  language Language @relation(fields: [languageId], references: [id])

  @@id([rehabId, languageId])
}

model RehabAmenity {
  rehabId   String
  amenityId String

  rehab   RehabOrg @relation(fields: [rehabId], references: [id])
  amenity Amenity  @relation(fields: [amenityId], references: [id])

  @@id([rehabId, amenityId])
}

model RehabEnvironment {
  rehabId       String
  environmentId String

  rehab       RehabOrg    @relation(fields: [rehabId], references: [id])
  environment Environment @relation(fields: [environmentId], references: [id])

  @@id([rehabId, environmentId])
}

model RehabSettingStyle {
  rehabId        String
  settingStyleId String

  rehab        RehabOrg     @relation(fields: [rehabId], references: [id])
  settingStyle SettingStyle @relation(fields: [settingStyleId], references: [id])

  @@id([rehabId, settingStyleId])
}

model RehabLuxuryTier {
  rehabId     String
  luxuryTierId String

  rehab      RehabOrg   @relation(fields: [rehabId], references: [id])
  luxuryTier LuxuryTier @relation(fields: [luxuryTierId], references: [id])

  @@id([rehabId, luxuryTierId])
}

model RehabProgramFeatureGlobal {
  rehabId          String
  programFeatureId String

  rehab          RehabOrg       @relation(fields: [rehabId], references: [id])
  programFeature ProgramFeature @relation(fields: [programFeatureId], references: [id])

  @@id([rehabId, programFeatureId])
}

// ------------------------------------------------------
// Campus-level join tables
// ------------------------------------------------------

model RehabCampusAmenity {
  campusId  String
  amenityId String

  campus  RehabCampus @relation(fields: [campusId], references: [id])
  amenity Amenity     @relation(fields: [amenityId], references: [id])

  @@id([campusId, amenityId])
}

model RehabCampusLanguage {
  campusId   String
  languageId String

  campus   RehabCampus @relation(fields: [campusId], references: [id])
  language Language    @relation(fields: [languageId], references: [id])

  @@id([campusId, languageId])
}

model RehabCampusPopulation {
  campusId     String
  populationId String

  campus     RehabCampus @relation(fields: [campusId], references: [id])
  population Population  @relation(fields: [populationId], references: [id])

  @@id([campusId, populationId])
}

model RehabCampusEnvironment {
  campusId      String
  environmentId String

  campus      RehabCampus @relation(fields: [campusId], references: [id])
  environment Environment @relation(fields: [environmentId], references: [id])

  @@id([campusId, environmentId])
}

model RehabCampusSettingStyle {
  campusId       String
  settingStyleId String

  campus       RehabCampus @relation(fields: [campusId], references: [id])
  settingStyle SettingStyle @relation(fields: [settingStyleId], references: [id])

  @@id([campusId, settingStyleId])
}

model RehabCampusLuxuryTier {
  campusId     String
  luxuryTierId String

  campus     RehabCampus @relation(fields: [campusId], references: [id])
  luxuryTier LuxuryTier  @relation(fields: [luxuryTierId], references: [id])

  @@id([campusId, luxuryTierId])
}

// ------------------------------------------------------
// Program-level join tables
// ------------------------------------------------------

model RehabProgramDetoxService {
  programId      String
  detoxServiceId String

  program      RehabProgram @relation(fields: [programId], references: [id])
  detoxService DetoxService @relation(fields: [detoxServiceId], references: [id])

  @@id([programId, detoxServiceId])
}

model RehabProgramMATType {
  programId String
  matTypeId String

  program RehabProgram @relation(fields: [programId], references: [id])
  matType MATType      @relation(fields: [matTypeId], references: [id])

  @@id([programId, matTypeId])
}

model RehabProgramService {
  programId String
  serviceId String

  program RehabProgram @relation(fields: [programId], references: [id])
  service Service      @relation(fields: [serviceId], references: [id])

  @@id([programId, serviceId])
}

model RehabProgramPopulation {
  programId    String
  populationId String

  program    RehabProgram @relation(fields: [programId], references: [id])
  population Population   @relation(fields: [populationId], references: [id])

  @@id([programId, populationId])
}

model RehabProgramLanguage {
  programId  String
  languageId String

  program  RehabProgram @relation(fields: [programId], references: [id])
  language Language     @relation(fields: [languageId], references: [id])

  @@id([programId, languageId])
}

model RehabProgramAmenity {
  programId String
  amenityId String

  program RehabProgram @relation(fields: [programId], references: [id])
  amenity Amenity      @relation(fields: [amenityId], references: [id])

  @@id([programId, amenityId])
}

model RehabProgramFeature {
  programId       String
  programFeatureId String

  program        RehabProgram  @relation(fields: [programId], references: [id])
  programFeature ProgramFeature @relation(fields: [programFeatureId], references: [id])

  @@id([programId, programFeatureId])
}

model RehabProgramSubstance {
  programId   String
  substanceId String

  program   RehabProgram @relation(fields: [programId], references: [id])
  substance Substance    @relation(fields: [substanceId], references: [id])

  @@id([programId, substanceId])
}

// ------------------------------------------------------
// Insurance & payment modeling with scope
// ------------------------------------------------------

model RehabInsurancePayer {
  id               String @id @default(cuid())

  rehabId          String
  campusId         String?
  programId        String?
  insurancePayerId String

  scope            InsuranceScope @default(ORG)
  networkStatus    NetworkStatus  @default(UNKNOWN)

  // Cost signals (facility currency)
  averageAdmissionPrice  Int? // typical full stay charge
  estimatedPatientOopMin Int? // estimated minimum out-of-pocket
  estimatedPatientOopMax Int? // estimated maximum out-of-pocket

  requiresPreauth               Boolean?
  acceptsOutOfNetworkWithOopCap Boolean?

  notes    String?
  overview String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rehab          RehabOrg      @relation(fields: [rehabId], references: [id])
  insurancePayer InsurancePayer @relation(fields: [insurancePayerId], references: [id])

  @@index([rehabId])
  @@index([campusId])
  @@index([programId])
  @@index([insurancePayerId])
}

model RehabPaymentOption {
  id                String @id @default(cuid())

  rehabId           String
  campusId          String?
  programId         String?
  paymentOptionId   String

  descriptionOverride String? // program- or campus-specific note

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  rehab             RehabOrg      @relation(fields: [rehabId], references: [id])
  paymentOption     PaymentOption @relation(fields: [paymentOptionId], references: [id])

  @@index([rehabId])
  @@index([campusId])
  @@index([programId])
  @@index([paymentOptionId])
}

// ------------------------------------------------------
// Org / Campus / Program: Reviews, testimonials, stories
// ------------------------------------------------------

// --- Org-level ---

model OrgReview {
  id         String @id @default(cuid())
  rehabOrgId String     

  

  rating     Int      // 1‚Äì5
  title      String?
  body       String

  reviewerType ReviewerType @default(OTHER)
  reviewerName String?
  reviewerRole String?

  source      ReviewSource @default(INTERNAL)
  externalUrl String?

  isFeatured  Boolean @default(false)
  isVerified  Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rehabOrg    RehabOrg @relation(fields: [rehabOrgId], references: [id])

  @@index([rehabOrgId])
}

model OrgTestimonial {
  id              String @id @default(cuid())
  rehabOrgId      String

  quote           String
  attributionName String?
  attributionRole String?
  source          String?  // "patient", "family", "clinician", etc.

  isFeatured      Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  rehabOrg        RehabOrg @relation(fields: [rehabOrgId], references: [id])

  @@index([rehabOrgId])
}

model OrgStory {
  id        String @id @default(cuid())
  rehabOrgId String

  storyType StoryType @default(OTHER)

  title     String   @unique 
  slug      String   @unique
  summary   String?
  body      String

  tags      String[]

  isPublic  Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rehabOrg  RehabOrg @relation(fields: [rehabOrgId], references: [id])

  @@index([rehabOrgId])
}

// --- Campus-level ---

model CampusReview {
  id        String @id @default(cuid())
  campusId  String

  rating    Int
  title     String? 
  body      String

  reviewerType ReviewerType @default(OTHER)
  reviewerName String?
  reviewerRole String?

  source      ReviewSource @default(INTERNAL)
  externalUrl String?

  isFeatured  Boolean @default(false)
  isVerified  Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campus      RehabCampus @relation(fields: [campusId], references: [id])

  @@index([campusId])
}

model CampusTestimonial {
  id              String @id @default(cuid())
  campusId        String

  quote           String
  attributionName String?
  attributionRole String?
  source          String?

  isFeatured      Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  campus          RehabCampus @relation(fields: [campusId], references: [id])

  @@index([campusId])
}

model CampusStory {
  id         String @id @default(cuid())
  campusId   String

  storyType  StoryType @default(OTHER)

  title      String @unique 
  slug       String   @unique
  summary    String?
  body       String

  tags       String[]
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campus     RehabCampus @relation(fields: [campusId], references: [id])

  @@index([campusId])
}

// --- Program-level ---

model ProgramReview {
  id        String @id @default(cuid())
  programId String

  rating    Int
  title     String?
  body      String

  reviewerType ReviewerType @default(OTHER)
  reviewerName String?
  reviewerRole String?

  source      ReviewSource @default(INTERNAL)
  externalUrl String?

  isFeatured  Boolean @default(false)
  isVerified  Boolean @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  program     RehabProgram @relation(fields: [programId], references: [id])

  @@index([programId])
}

model ProgramTestimonial {
  id              String @id @default(cuid())
  programId       String

  quote           String
  attributionName String?
  attributionRole String?
  source          String?

  isFeatured      Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  program         RehabProgram @relation(fields: [programId], references: [id])

  @@index([programId])
}

model ProgramStory {
  id        String @id @default(cuid())
  programId String

  storyType StoryType @default(OTHER)

  title     String @unique 
  slug      String   @unique
  summary   String?
  body      String

  tags      String[]
  isPublic  Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program   RehabProgram @relation(fields: [programId], references: [id])

  @@index([programId])
}


enum MediaOwnerType {
  REHAB_ORG
  REHAB_CAMPUS
  REHAB_PROGRAM
  INSURANCE_PAYER 
  PARENT_COMPANY 
  USER  

}

enum MediaKind {
  IMAGE
  VIDEO
}

model MediaAsset {
  id         String        @id @default(cuid())
  ownerType  MediaOwnerType
  ownerId    String        // id of RehabOrg / RehabCampus / RehabProgram / InsurancePayer
  kind       MediaKind     @default(IMAGE)

  role       String?       // "hero", "logo", "gallery", "floorplan", etc.
  bucketKey  String        // e.g. "rehab-orgs/{id}/gallery/abc123.jpg"
  cdnUrl     String        // fully resolved CDN URL

  altText    String?
  caption    String?
  sortOrder  Int           @default(0)
  isPrimary  Boolean       @default(false)

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([ownerType, ownerId])
}