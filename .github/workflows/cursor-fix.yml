name: Cursor Fix (Write Access)

on:
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]

jobs:
    cursor-fix:
        # Only trigger on @cursor-fix command from authorized users
        if: |
            (
              github.event_name == 'issue_comment' ||
              github.event_name == 'pull_request_review_comment'
            ) &&
            contains(github.event.comment.body, '@cursor-fix') &&
            contains(fromJSON('["Overton77"]'), github.event.comment.user.login)

        runs-on: ubuntu-latest

        permissions:
            contents: write # Allow creating branches and editing files
            pull-requests: write # Allow creating and updating pull requests
            issues: write # Allow commenting on and updating issues
            id-token: write # Required for OIDC authentication
            actions: read # Read CI results

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for better context

            - name: Configure Git
              run: |
                  git config user.name "cursor-bot"
                  git config user.email "cursor-bot@users.noreply.github.com"

            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH

            - name: Load fix instructions (with issue/PR body)
              id: load-instructions
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # for gh auth
              run: |
                  # Determine whether this was triggered from an issue comment or PR review comment
                  if [ "${{ github.event_name }}" = "issue_comment" ]; then
                    ITEM_NUMBER="${{ github.event.issue.number }}"
                    ITEM_KIND="issue"
                  else
                    ITEM_NUMBER="${{ github.event.pull_request.number }}"
                    ITEM_KIND="pull_request"
                  fi

                  # Fetch the full issue/PR body using GitHub CLI
                  if [ "$ITEM_KIND" = "issue" ]; then
                    ITEM_TEXT=$(gh issue view "$ITEM_NUMBER" --json title,body,number -q '"# " + .title + "\n\n" + .body' || echo "UNAVAILABLE")
                  else
                    ITEM_TEXT=$(gh pr view "$ITEM_NUMBER" --json title,body,number -q '"# " + .title + "\n\n" + .body' || echo "UNAVAILABLE")
                  fi

                  # Read the template and replace placeholders
                  INSTRUCTIONS=$(cat .github/issue_fix_prompt.md | sed 's/{AI_ASSISTANT}/cursor/g')

                  # Build the full prompt file
                  echo "# GitHub Context" > /tmp/cursor_fix_prompt.txt
                  echo "- Repository: ${{ github.repository }}" >> /tmp/cursor_fix_prompt.txt
                  echo "- Item Type: ${ITEM_KIND}" >> /tmp/cursor_fix_prompt.txt
                  echo "- Issue/PR Number: ${ITEM_NUMBER}" >> /tmp/cursor_fix_prompt.txt
                  echo "- Triggered by: ${{ github.event.comment.user.login }}" >> /tmp/cursor_fix_prompt.txt
                  echo "" >> /tmp/cursor_fix_prompt.txt

                  echo "## Issue / PR Description" >> /tmp/cursor_fix_prompt.txt
                  printf '%s\n' "$ITEM_TEXT" >> /tmp/cursor_fix_prompt.txt
                  echo "" >> /tmp/cursor_fix_prompt.txt

                  echo "## Fix Instructions" >> /tmp/cursor_fix_prompt.txt
                  printf '%s\n' "$INSTRUCTIONS" >> /tmp/cursor_fix_prompt.txt

            - name: Run Cursor Fix
              env:
                  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Run cursor-agent with the fix instructions and full write permissions
                  cursor-agent -p "$(cat /tmp/cursor_fix_prompt.txt)" --model gpt-5 --force

    unauthorized-message:
        # Post message for unauthorized users
        if: |
            (
              github.event_name == 'issue_comment' ||
              github.event_name == 'pull_request_review_comment'
            ) &&
            contains(github.event.comment.body, '@cursor-fix') &&
            !contains(fromJSON('["Overton77"]'), github.event.comment.user.login)

        runs-on: ubuntu-latest

        permissions:
            issues: write
            pull-requests: write

        steps:
            - name: Post unauthorized message
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = {
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `‚ùå @${context.actor} - You are not authorized to trigger Cursor fixes.\n\nOnly maintainers can trigger Cursor: Please ask a maintainer to run the fix command.`
                      };

                      if (context.eventName === 'issue_comment') {
                        await github.rest.issues.createComment({
                          ...comment,
                          issue_number: context.issue.number
                        });
                      } else if (context.eventName === 'pull_request_review_comment') {
                        await github.rest.pulls.createReplyForReviewComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: context.payload.pull_request.number,
                          comment_id: context.payload.comment.id,
                          body: comment.body
                        });
                      }
