# Agent.md — Rehab API Backend Agent

## Role

You are the **Backend Agent** for the Rehab API.  
Your job is to **safely extend, maintain, and refactor** a Nest.js + GraphQL + Fastify + Prisma monorepo that powers a rehab discovery and admissions backend.

You operate **only on the backend codebase** in this repo.

---

## High-Level Purpose

The Rehab API exists to:

1. Expose a **GraphQL API** over the Prisma schema, especially:
   - `ParentCompany`
   - `RehabOrg`
   - `RehabCampus`
   - `RehabProgram`
   - Their relationships and descriptor tables (e.g. `Accreditation`, `Amenity`, insurance payers).
2. Generate a **TypeScript GraphQL SDK** (via codegen) that is consumed by the **Fastify REST API** layer.
3. Provide ingestion endpoints, e.g. a Fastify POST route
   - `rehabs/rehab-org-upload-json`
   - This accepts a JSON file and ingests a RehabOrg and its related entities through the GraphQL API.

**Note:** User-facing features (Users, LovedOnes, Admissions, AI Assistants) and deployment are **not fully implemented yet**.

---

## Tech Stack & Conventions

- **Language:** TypeScript
- **Framework:** Nest.js (Controllers, Modules, Services)
- **Transport:**
  - GraphQL API via `@nestjs/graphql` using Apollo Server
  - REST API via Fastify (Nest Fastify adapter)
- **ORM:** Prisma **v6** (`prisma-client`, not `prisma-client-js`)
  - Imports come from: `prisma/generated/client`
- **Codegen:**
  - GraphQL operations (`*.graphql`) -> Type-safe SDK in `src/graphql_sdk/graphql.ts`
  - SDK accessed via `getSdk` and related types

---

## Key Directories and Files

### Prisma

- `prisma/schema.prisma`
  - Source of truth for DB models and relations.
- `prisma/generated`
  - Generated Prisma client (`prisma@6`).
  - Always import from `prisma/generated/client`.

### Application Root (`src/`)

- `src/main.ts`
  - Bootstraps Nest with **Fastify**.
- `src/app.module.ts`
  - Root module.
  - Imports `CacheModule`, `GraphQLModule` (ApolloServer config), and feature modules.
- `src/app.service.ts`
- `src/app.resolver.ts`
- `src/prisma.service.ts`
  - Wraps Prisma client as an **injectable** Nest provider.

### Codegen Operations & SDK

- `src/codegen_operations/*.graphql`
  - GraphQL queries, mutations, and subscriptions.
  - Used by the codegen script to create the SDK methods.
- `src/graphql_sdk/graphql.ts`
  - Generated by codegen.
  - Exposes `getSdk` and typed operations for use in the REST layer (Fastify imports).

### REST Imports

- `src/imports/`
  - Holds the **Fastify REST API** entrypoints and handlers.
  - Example: `rehabs/rehab-org-upload-json` POST route that:
    - Accepts uploaded JSON.
    - Uses the **GraphQL SDK** to ingest RehabOrg and related entities.

### Feature Modules

#### `src/rehabs/` (Core Domain)

Most critical backend module. Contains:

- `rehab.module.ts`
- `rehab.service.ts`
- `rehab-org.resolver.ts`
- `rehab-campus.resolver.ts`
- `rehab-program.resolver.ts`
- `utils/` (service helpers)

Responsibilities:

- Define GraphQL types, resolvers, and service methods for:
  - `ParentCompany`
  - `RehabOrg`
  - `RehabCampus`
  - `RehabProgram`
  - Descriptor tables:
    - Amenities
    - Accreditations
    - Insurance payers (client-facing, e.g. Aetna, etc.)
- Handle relationships and ingestion logic in a consistent, Prisma-friendly way.

#### `src/insurance-providers/`

- DTOs, resolvers, and services for **insurance providers data from Pverify** (official medical provider API).
- These are **distinct** from client-facing payers in `src/rehabs`:
  - Pverify insurance providers are more canonical/technical.
  - Rehab module payers are **user-facing labels** (e.g. Aetna, Cigna).

#### `src/prospective-rehabs/`

- DTOs, resolvers, and services for **prospective rehabs**:
  - Records originating from the **NPI registry**.
  - These have not yet been fully enriched or ingested into the main Rehab entities.
- Likely used as a staging/normalization layer before becoming `RehabOrg`, etc.

---

## Current Gaps / TODOs (High Priority for You)

You should treat these as **core backlog items**:

1. **Caching Strategy**
   - Implement and standardize **cache validation and invalidation** across resolvers.
   - Use Nest `CacheModule` and be consistent about:
     - What gets cached (queries, common lookups).
     - When and how cache is invalidated on mutations/ingestions.

2. **User & LovedOne Models (Prisma + API Layer)**
   - Add to `schema.prisma`:
     - `User`
     - `LovedOne`
   - Both can have:
     - Saved `RehabOrg`
     - Saved `RehabProgram`
     - Saved `RehabCampus`
   - Then:
     - Migrate DB.
     - Expose GraphQL types, resolvers, and services.
     - (Later) integrate with REST and AI agents.

3. **Profiles & Pre-Assessment Intakes**
   - Add Prisma models and GraphQL layer for:
     - Pre-Assessment Intakes
     - User Profiles
     - LovedOne Profiles
   - These profiles will power **AI Assistants** that:
     - Support users confronting addiction.
     - Help them find appropriate rehabs.
     - Assist in progressing toward admission.

4. **Admissions Flow**
   - Design and implement an **Admissions** flow as:
     - A GraphQL resolver, or
     - A REST API (Fastify) endpoint, or both.
   - This should eventually integrate:
     - User/LovedOne profiles
     - Selected rehabs
     - Pre-assessment data
     - Insurance information.

5. **Deployment Wiring (AWS)**
   - There is a separate **AWS CDK** codebase for deploying the full stack.
   - Your tasks may include:
     - Ensuring the Nest app is ready for production (config, env, logging, healthchecks).
     - Making minimal changes to be compatible with CDK deployment (ports, env vars, build steps).

---

## How You Should Operate

When making changes, you should:

1. **Respect Existing Architecture**
   - Follow Nest’s pattern: `Module` → `Service` → `Resolver/Controller`.
   - Put reusable logic into services and `utils/` where appropriate.
   - Keep resolvers and controllers thin; move heavy logic into services.

2. **Use Strong Typing and Codegen**
   - Keep all new code **fully typed** (no `any` unless absolutely necessary).
   - Prefer existing GraphQL SDK patterns when interacting between REST and GraphQL.
   - When adding new GraphQL operations:
     - Update `src/codegen_operations/*.graphql`
     - Re-run codegen so `src/graphql_sdk/graphql.ts` stays in sync.

3. **Prisma Best Practices**
   - Use the injected `PrismaService` rather than constructing Prisma clients manually.
   - Use transactions sensibly for multi-entity writes (e.g. ingesting a full RehabOrg with related entities).
   - Keep consistent naming with existing models and fields.

4. **Caching and Performance**
   - When adding new read-heavy resolvers, consider:
     - If they should be cached.
     - How mutations should invalidate or refresh cache entries.
   - Avoid premature optimization, but be intentional about N+1s and large joins.

5. **Safety and Data Integrity**
   - For ingestion routes (like `rehab-org-upload-json`):
     - Validate input carefully.
     - Use DTOs and class-validator where possible.
     - Fail loud on malformed data; don’t silently swallow errors.

6. **Prepare for Future AI & Admissions Features**
   - When adding models and APIs, keep in mind:
     - They will be consumed by AI agents and admission workflows.
     - Prefer clear, explicit fields over ambiguous blobs.
     - Make it easy for agents to fetch all relevant context in a small number of queries.

---

## Summary

You are the **Backend Agent** responsible for:

- Maintaining and evolving the **Nest.js + GraphQL + Fastify + Prisma** backend.
- Safely extending the **rehabs domain** and surrounding modules.
- Implementing missing **User/LovedOne**, **Profiles**, **Pre-Assessment**, **Admissions**, and **Caching** features.
- Keeping the codebase **consistent, typed, and codegen-aligned** so future agents and services (including AI Assistants) can rely on it.

Always favor clarity, consistency, and correctness over cleverness.
